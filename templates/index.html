<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DesignIT 연구실 논문 성과</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
        rel="stylesheet"
    />
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 1.5em;
        }

        /* 상단 툴바 및 필터 영역 */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .filter-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .filter-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .selected-filters {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .filter-tag {
            background-color: #e1e1e1;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-tag button {
            border: none;
            background: none;
            cursor: pointer;
            padding: 0 4px;
        }

        /* 버튼 스타일 */
        .toggle-button {
            padding: 8px 16px;
            background-color: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .toggle-button:hover {
            background-color: #2c3e50;
        }
        .toggle-button.active {
            background-color: #2980b9;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
        }
        .export-container button {
            padding: 8px 16px;
            background-color: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .export-container button:hover {
            background-color: #2c3e50;
        }

        /* 카테고리 영역 및 테이블 */
        .category {
            margin-bottom: 2em;
        }
        .category-header {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 1em;
            padding-bottom: 0.5em;
            border-bottom: 2px solid #eee;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-row {
            line-height: 1.8;
        }

        /* 번호 뒤에 마침표를 붙임 */
        td.number {
            position: relative;
            min-width: 2em;
            color: #666;
            font-weight: 500;
            padding-right: 1em; /* 번호 뒤쪽 여백 살짝 늘림 */
        }

        /* 연도와 저자 사이 띄우기 & 저자 줄바꿈 방지 */
        td.year {
            padding-right: 2em; /* 연도 뒤쪽에 여백(2em) */
        }
        td.author {
            white-space: nowrap; /* 저자 이름 끊어지지 않도록 */
        }

        /* 테이블 마지막 열도 조금 여백 */
        .data-row td:last-child {
            padding-right: 0.5em;
        }

        /* 글자 강조 */
        .year {
            color: #666;
        }
        .title {
            font-weight: 500;
        }
        .doi a {
            color: #2980b9;
            text-decoration: none;
        }
        .doi a:hover {
            text-decoration: underline;
        }

        /* 복사 버튼 */
        .citation-copy {
            padding: 4px 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .citation-copy:hover {
            background-color: #e9ecef;
        }

        /* 사사(acknowledgement) 표기 토글 */
        .acknowledgement {
            display: none;
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }
        .show-acknowledgement .acknowledgement {
            display: table-cell;
        }
    </style>
</head>
<body>
    <!-- 페이지 헤더 -->
    <h1>DesignIT 연구실 논문 성과</h1>

    <!-- 툴바 영역 -->
    <div class="toolbar">
        <div class="filter-container">
            <div class="filter-controls">
                <div class="filter-box">
                    <!-- 사사 표기 보기/숨기기 버튼 -->
                    <button
                        id="toggleAcknowledgement"
                        class="toggle-button"
                        onclick="toggleAcknowledgement()"
                    >
                        사사표기 보기
                    </button>
                    <!-- 카테고리 필터 -->
                    <select id="categoryFilter" onchange="addCategoryFilter()">
                        <option value="">카테고리 선택</option>
                        <option value="도서">도서</option>
                        <option value="수상">수상</option>
                        <option value="특허">특허</option>
                        <option value="SW등록">SW등록</option>
                        <option value="국제논문">국제논문</option>
                        <option value="국내논문">국내논문</option>
                        <option value="국제컨퍼런스">국제컨퍼런스</option>
                        <option value="국내컨퍼런스">국내컨퍼런스</option>
                    </select>
                    <!-- 연도 필터 -->
                    <select id="yearFilter" onchange="addYearFilter()">
                        <option value="">연도 선택</option>
                    </select>
                    <!-- Word 내보내기 버튼 -->
                    <div class="export-container">
                        <button onclick="exportToWord()">Word로 내보내기</button>
                    </div>
                </div>
            </div>
            <div id="selectedFilters" class="selected-filters"></div>
        </div>
    </div>

    <!-- 데이터 표시 -->
    {% if categories %}
        {% for category, entries in categories.items() %}
            <div class="category">
                <h3 class="category-header">{{ category }}</h3>
                <table>
                    <tbody>
                        {% for entry in entries %}
                            <tr class="data-row">
                                <td class="number">{{ entry.number }}.</td>
                                <td class="year">{{ entry.year }}</td>
                                <td class="author">{{ entry.author }}</td>
                                <td class="title">{{ entry.title }}</td>

                                {% if category == '수상' %}
                                    <td class="journal">{{ entry.journal }}</td>
                                    <td class="volume">{{ entry.volume }}</td>

                                {% elif category in ['특허', 'SW등록'] %}
                                    <td class="journal">{{ entry.volume }}</td>
                                    <td class="acknowledgement">{{ entry.acknowledgement }}</td>

                                {% else %}
                                    <td class="journal">{{ entry.journal }}</td>
                                    <td class="volume">{{ entry.volume }}</td>
                                    <td class="pages">{{ entry.pages }}</td>
                                    <td class="doi">
                                        {% if entry.doi %}
                                            <a href="https://doi.org/{{ entry.doi }}" target="_blank">
                                                {{ entry.doi }}
                                            </a>
                                        {% endif %}
                                    </td>
                                    <td class="acknowledgement">{{ entry.acknowledgement }}</td>
                                {% endif %}

                                <td>
                                    <button
                                        class="citation-copy"
                                        onclick="copyAPA(this.parentElement.parentElement)"
                                    >
                                        복사
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    {% else %}
        <p>데이터를 불러올 수 없습니다.</p>
    {% endif %}

    <!-- 스크립트: 필터, 내보내기, 복사 등 -->
    <script>
        let selectedFilters = {
            category: new Set(),
            year: new Set()
        };

        function toggleAcknowledgement() {
            const button = document.getElementById('toggleAcknowledgement');
            document.body.classList.toggle('show-acknowledgement');
            button.classList.toggle('active');
            button.textContent = document.body.classList.contains('show-acknowledgement')
                ? '사사표기 숨기기'
                : '사사표기 보기';
        }

        /* 페이지 로드 시 연도 필터 초기화 */
        window.addEventListener('load', function() {
            initializeYearFilter();
        });

        function initializeYearFilter() {
            const years = new Set();
            document.querySelectorAll('.year').forEach(el => {
                const year = el.textContent.trim();
                if (year) years.add(year);
            });

            const yearFilter = document.getElementById('yearFilter');
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            yearFilter.innerHTML = '<option value="">연도 선택</option>' +
                sortedYears.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function addCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            const value = select.value;
            if (value) {
                selectedFilters.category.add(value);
                updateFilterTags();
                applyFilters();
                select.selectedIndex = 0;
            }
        }

        function addYearFilter() {
            const select = document.getElementById('yearFilter');
            const value = select.value;
            if (value) {
                selectedFilters.year.add(value);
                updateFilterTags();
                applyFilters();
                select.selectedIndex = 0;
            }
        }

        function removeFilter(type, value) {
            selectedFilters[type].delete(value);
            updateFilterTags();
            applyFilters();
        }

        function updateFilterTags() {
            const container = document.getElementById('selectedFilters');
            container.innerHTML = '';

            selectedFilters.category.forEach(value => {
                addFilterTag(container, 'category', `카테고리: ${value}`);
            });
            selectedFilters.year.forEach(value => {
                addFilterTag(container, 'year', `연도: ${value}`);
            });
        }

        function addFilterTag(container, type, value) {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            const filterValue = value.split(': ')[1];
            tag.innerHTML = `
                ${value}
                <button onclick="removeFilter('${type}', '${filterValue}')">&times;</button>
            `;
            container.appendChild(tag);
        }

        function applyFilters() {
            const rows = document.getElementsByClassName('data-row');
            Array.from(rows).forEach(row => {
                let visible = true;

                if (selectedFilters.category.size > 0) {
                    const cat = row
                        .closest('.category')
                        .querySelector('.category-header')
                        .textContent;
                    if (!selectedFilters.category.has(cat)) {
                        visible = false;
                    }
                }

                if (visible && selectedFilters.year.size > 0) {
                    const year = row.querySelector('.year').textContent;
                    if (!selectedFilters.year.has(year)) {
                        visible = false;
                    }
                }

                row.style.display = visible ? '' : 'none';
            });

            updateCategoryVisibility();
        }

        function updateCategoryVisibility() {
            document.querySelectorAll('.category').forEach(category => {
                const hasVisibleRows = Array.from(
                    category.querySelectorAll('.data-row')
                ).some(row => row.style.display !== 'none');
                category.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function exportToWord() {
            const exportData = {};
            const visibleCategories = Array.from(
                document.querySelectorAll('.category')
            ).filter(cat => window.getComputedStyle(cat).display !== 'none');

            visibleCategories.forEach(category => {
                const categoryName = category.querySelector('.category-header').textContent;
                const rows = Array.from(category.querySelectorAll('.data-row')).filter(
                    r => window.getComputedStyle(r).display !== 'none'
                );

                if (rows.length > 0) {
                    exportData[categoryName] = rows.map(row => ({
                        year: row.querySelector('.year').textContent.trim(),
                        author: row.querySelector('.author').textContent.trim(),
                        title: row.querySelector('.title').textContent.trim(),
                        journal: row.querySelector('.journal').textContent.trim(),
                        volume: row.querySelector('.volume')?.textContent.trim() || '',
                        pages: row.querySelector('.pages')?.textContent.trim() || '',
                        doi: row.querySelector('.doi a')?.textContent.trim() || ''
                    }));
                }
            });

            fetch('/export/word', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(exportData)
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'DesignITLab_CV.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
        }

        function copyAPA(row) {
            const authors = row.querySelector('.author').textContent.trim();
            const year = row.querySelector('.year').textContent.trim();
            const title = row.querySelector('.title').textContent.trim();
            const journal = row.querySelector('.journal').textContent.trim();
            const category = row
                .closest('.category')
                .querySelector('.category-header').textContent;

            let citation = `${authors} (${year}). ${title}`;

            if (category === '수상') {
                const content = row.querySelector('.volume').textContent.trim();
                citation += `. ${journal}`;
                if (content) citation += `, ${content}`;
            } else if (category === '특허') {
                citation += `. 출원번호: ${journal}, ${year}`;
            } else if (category === 'SW등록') {
                citation += `. 등록번호: ${journal}, ${year}`;
            } else {
                const volume = row.querySelector('.volume')?.textContent.trim();
                const pages = row.querySelector('.pages')?.textContent.trim();
                const doi = row.querySelector('.doi')?.textContent.trim();
                const cleanJournal = journal.replace(/<\/?i>/g, '');
                citation += `. ${cleanJournal}`;

                if (volume || pages) {
                    const parts = [];
                    if (volume) {
                        const cleanVolume = volume.replace(/<\/?i>/g, '');
                        parts.push(cleanVolume);
                    }
                    if (pages) parts.push(pages);
                    if (parts.length > 0) {
                        citation += `, ${parts.join(', ')}`;
                    }
                }

                if (doi) {
                    const cleanDoi = doi.replace(/^https:\/\/doi\.org\//g, '').trim();
                    if (cleanDoi) citation += `. https://doi.org/${cleanDoi}`;
                }
            }

            citation = citation.replace(/\s+/g, ' ').trim();
            if (!citation.endsWith('.')) citation += '.';

            navigator.clipboard.writeText(citation).then(() => {
                const button = row.querySelector('.citation-copy');
                button.textContent = '복사됨';
                setTimeout(() => (button.textContent = '복사'), 2000);
            });
        }
    </script>
</body>
</html>
