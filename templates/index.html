<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesignIT 연구실 논문 성과</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 이전 스타일 유지 */
        .acknowledgement {
            display: none;  /* 기본적으로 사사표기 숨김 */
        }
        .show-acknowledgement .acknowledgement {
            display: table-cell;  /* 토글 시 보이도록 설정 */
        }
        .toggle-button {
            padding: 8px 16px;
            background-color: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .toggle-button:hover {
            background-color: #2c3e50;
        }
        .toggle-button.active {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <h1>DesignIT 연구실 논문 성과</h1>

    <div class="toolbar">
        <div class="filter-container">
            <div class="filter-controls">
                <div class="filter-box">
                    <button id="toggleAcknowledgement" class="toggle-button" onclick="toggleAcknowledgement()">
                        사사표기 보기
                    </button>
                    <select id="categoryFilter" onchange="addCategoryFilter()">
                        <option value="">카테고리 선택</option>
                        <option value="도서">도서</option>
                        <option value="수상">수상</option>
                        <option value="특허">특허</option>
                        <option value="SW등록">SW등록</option>
                        <option value="국제논문">국제논문</option>
                        <option value="국내논문">국내논문</option>
                        <option value="국제컨퍼런스">국제컨퍼런스</option>
                        <option value="국내컨퍼런스">국내컨퍼런스</option>
                    </select>
                    <select id="yearFilter" onchange="addYearFilter()">
                        <option value="">연도 선택</option>
                    </select>
                    <div class="export-container">
                        <button onclick="exportToWord()">Word로 내보내기</button>
                    </div>
                </div>
            </div>
            <div id="selectedFilters" class="selected-filters"></div>
        </div>
    </div>

    {% if categories %}
        {% for category, entries in categories.items() %}
            <div class="category">
                <h3 class="category-header">{{ category }}</h3>
                <table>
                    <thead>
                        <tr>
                            <th class="number">번호</th>
                            <th class="year">연도</th>
                            <th class="author">저자명</th>
                            <th class="title">제목</th>
                            {% if category == '수상' %}
                                <th class="journal">주관기관</th>
                                <th class="volume">내용</th>
                            {% elif category == '특허' %}
                                <th class="journal">출원번호</th>
                                <th class="acknowledgement">사사표기</th>
                            {% elif category == 'SW등록' %}
                                <th class="journal">등록번호</th>
                                <th class="acknowledgement">사사표기</th>
                            {% else %}
                                <th class="journal">저널명</th>
                                <th class="volume">권(호)</th>
                                <th class="pages">페이지</th>
                                <th class="doi">DOI</th>
                                <th class="acknowledgement">사사표기</th>
                            {% endif %}
                            <th>인용</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                            <tr class="data-row">
                                <td class="number">{{ entry.number }}</td>
                                <td class="year">{{ entry.year }}</td>
                                <td class="author">{{ entry.author }}</td>
                                <td class="title">{{ entry.title }}</td>
                                {% if category == '수상' %}
                                    <td class="journal">{{ entry.journal }}</td>
                                    <td class="volume">{{ entry.volume }}</td>
                                {% elif category in ['특허', 'SW등록'] %}
                                    <td class="journal">{{ entry.volume }}</td>
                                    <td class="acknowledgement">{{ entry.acknowledgement }}</td>
                                {% else %}
                                    <td class="journal">{{ entry.journal }}</td>
                                    <td class="volume">{{ entry.volume }}</td>
                                    <td class="pages">{{ entry.pages }}</td>
                                    <td class="doi">
                                        {% if entry.doi %}
                                            <a href="https://doi.org/{{ entry.doi }}" target="_blank">{{ entry.doi }}</a>
                                        {% endif %}
                                    </td>
                                    <td class="acknowledgement">{{ entry.acknowledgement }}</td>
                                {% endif %}
                                <td>
                                    <button class="citation-copy" onclick="copyAPA(this.parentElement.parentElement)">복사</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    {% else %}
        <p>데이터를 불러올 수 없습니다.</p>
    {% endif %}

    <script>
        let selectedFilters = {
            category: new Set(),
            year: new Set()
        };

        function toggleAcknowledgement() {
            const button = document.getElementById('toggleAcknowledgement');
            document.body.classList.toggle('show-acknowledgement');
            button.classList.toggle('active');
            button.textContent = document.body.classList.contains('show-acknowledgement') ? 
                '사사표기 숨기기' : '사사표기 보기';
        }

        function initializeYearFilter() {
            const years = new Set();
            document.querySelectorAll('.year').forEach(el => {
                const year = el.textContent.trim();
                if (year) years.add(year);
            });
            
            const yearFilter = document.getElementById('yearFilter');
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            yearFilter.innerHTML = '<option value="">연도 선택</option>' + 
                sortedYears.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function addCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            const value = select.value;
            if (value) {
                selectedFilters.category.add(value);
                updateFilterTags();
                applyFilters();
                select.selectedIndex = 0;
            }
        }

        function addYearFilter() {
            const select = document.getElementById('yearFilter');
            const value = select.value;
            if (value) {
                selectedFilters.year.add(value);
                updateFilterTags();
                applyFilters();
                select.selectedIndex = 0;
            }
        }

        function removeFilter(type, value) {
            selectedFilters[type].delete(value);
            updateFilterTags();
            applyFilters();
        }

        function updateFilterTags() {
            const container = document.getElementById('selectedFilters');
            container.innerHTML = '';
            
            selectedFilters.category.forEach(value => {
                addFilterTag(container, 'category', `카테고리: ${value}`);
            });
            
            selectedFilters.year.forEach(value => {
                addFilterTag(container, 'year', `연도: ${value}`);
            });
        }

        function addFilterTag(container, type, value) {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            const filterValue = value.split(': ')[1];
            tag.innerHTML = `
                ${value}
                <button onclick="removeFilter('${type}', '${filterValue}')">&times;</button>
            `;
            container.appendChild(tag);
        }

        function applyFilters() {
            const rows = document.getElementsByClassName('data-row');
            
            Array.from(rows).forEach(row => {
                let visible = true;

                if (visible && selectedFilters.category.size > 0) {
                    const category = row.closest('.category').querySelector('.category-header').textContent;
                    visible = selectedFilters.category.has(category);
                }

                if (visible && selectedFilters.year.size > 0) {
                    const year = row.querySelector('.year').textContent;
                    visible = selectedFilters.year.has(year);
                }

                row.style.display = visible ? '' : 'none';
            });

            updateCategoryVisibility();
        }

        function updateCategoryVisibility() {
            document.querySelectorAll('.category').forEach(category => {
                const hasVisibleRows = Array.from(category.querySelectorAll('.data-row'))
                    .some(row => row.style.display !== 'none');
                category.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function exportToWord() {
            const exportData = {};
            const visibleCategories = Array.from(document.querySelectorAll('.category'))
                .filter(category => window.getComputedStyle(category).display !== 'none');
            
            visibleCategories.forEach(category => {
                const categoryName = category.querySelector('.category-header').textContent;
                const visibleRows = Array.from(category.querySelectorAll('.data-row'))
                    .filter(row => window.getComputedStyle(row).display !== 'none');
                
                if (visibleRows.length > 0) {
                    exportData[categoryName] = visibleRows.map(row => ({
                        year: row.querySelector('.year').textContent.trim(),
                        author: row.querySelector('.author').textContent.trim(),
                        title: row.querySelector('.title').textContent.trim(),
                        journal: row.querySelector('.journal').textContent.trim(),
                        volume: row.querySelector('.volume')?.textContent.trim() || '',
                        pages: row.querySelector('.pages')?.textContent.trim() || '',
                        doi: row.querySelector('.doi a')?.textContent.trim() || ''  // 마지막 쉼표 제거
                    }));
                }
            });
            
            fetch('/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(exportData)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'DesignITLab_CV.docx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }

        function copyAPA(row) {
            const authors = row.querySelector('.author').textContent.trim();
            const year = row.querySelector('.year').textContent.trim();
            const title = row.querySelector('.title').textContent.trim();
            const journal = row.querySelector('.journal').textContent.trim();
            const category = row.closest('.category').querySelector('.category-header').textContent;
            
            let citation = `${authors} (${year}). ${title}`;
            
            if (category === '수상') {
                const content = row.querySelector('.volume').textContent.trim();
                citation += `. ${journal}`;
                if (content) citation += `, ${content}`;
            } else if (category === '특허') {
                citation += `. 출원번호: ${journal}, ${year}`;
            } else if (category === 'SW등록') {
                citation += `. 등록번호: ${journal}, ${year}`;
            } else {
                const volume = row.querySelector('.volume')?.textContent.trim();
                const pages = row.querySelector('.pages')?.textContent.trim();
                const doi = row.querySelector('.doi')?.textContent.trim();
                
                const cleanJournal = journal.replace(/<\/?i>/g, '');
                citation += `. ${cleanJournal}`;
                
                if (volume || pages) {
                    const parts = [];
                    if (volume) {
                        const volParts = volume.split('(');
                        const cleanVolume = volume.replace(/<\/?i>/g, '');
                        if (volParts.length > 1) {
                            parts.push(`${cleanVolume}`);
                        } else {
                            parts.push(cleanVolume);
                        }
                    }
                    if (pages) parts.push(pages);
                    if (parts.length > 0) {
                        citation += `, ${parts.join(', ')}`;
                    }
                }
                
                if (doi) {
                    const cleanDoi = doi.replace(/^https:\/\/doi\.org\//g, '').trim();
                    if (cleanDoi) citation += `. https://doi.org/${cleanDoi}`;
                }
            }
            
            citation = citation.replace(/\s+/g, ' ').trim();
            if (!citation.endsWith('.')) citation += '.';
            
            navigator.clipboard.writeText(citation).then(() => {
                const button = row.querySelector('.citation-copy');
                button.textContent = '복사됨';
                setTimeout(() => button.textContent = '복사', 2000);
            });
        }

        window.addEventListener('load', function() {
            initializeYearFilter();
        });
    </script>
</body>
</html>
